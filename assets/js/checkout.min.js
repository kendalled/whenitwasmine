// Handle Checkout
var uid = "";
firebase.auth().onAuthStateChanged(function (user) {
    if (user) {

        uid = user.uid;



        console.log('User ' + uid + ' is logged in.')
        document.getElementById("userID").value = uid
        // ...
    } else {
        console.log('User is not logged in.');
        // ...
    }
    // ...
});

function stripeHandlerToken(token) {
    firebase.firestore().collection('stripe_customers').doc(uid).collection('tokens').add({ token: token.id }).then(() => {
        console.log('Token created');
    });
}

function writeNewCharge() {
  //let newChargeSource = firebase.firestore().collection('stripe_customers').doc(uid).collection('sources');
  let cost = parseFloat(document.getElementById('ordertotal').value) * 100;
  firebase.firestore().collection('stripe_customers').doc(uid).collection('charges').add({
    amount: cost
  });
};

function transferFormData() {
  let name = document.getElementById('name').value;
  let email = document.getElementById('email').value;
  let line1 = document.getElementById('Shipping-address').value;
  let line2 = document.getElementById('line2').value;
  
  let city = document.getElementById('Shipping-address3').value;
  let state = document.getElementById('state').value;
  let zip = document.getElementById('zip').value;
  let phone = document.getElementById('phoneNumber').value;

  document.getElementById('hiddenName').value = name;
  document.getElementById('hiddenEmail').value = email;
  document.getElementById('hiddenline1').value = line1;
  document.getElementById('hiddenline2').value = line2;
  document.getElementById('hiddenCity').value = city;
  document.getElementById('hiddenState').value = state;
  document.getElementById('hiddenZip').value = zip;
  document.getElementById('hiddenPhone').value = phone;

}

$(document).ready(function () {
  // Handler for .ready() called.
  firebase.auth().signOut().then(function () {
    firebase
      .auth()
      .signInAnonymously()
      .catch(function (e) {
        e.code, e.message;
      }),
      console.log("Successful anon login (logged out).");

  }).catch(function (e) {
    console.log(e);
  })
  new Pikaday({ field: document.getElementById("datepicker") });
});
$('#toBilling').click(function() {
  // Get user data from form fields
  let state = document.getElementById('state').value;
  let city = document.getElementById('Shipping-address3').value;
  let zip = document.getElementById('zip').value;
  let phone = document.getElementById('phoneNumber').value;
  //let proofNum = 'PROOF' + document.getElementById('proofNumber').value;
  let line2 = document.getElementById('line2').value;
  let name = document.getElementById('name').value;
  let email = document.getElementById('email').value;
  let line1 = document.getElementById('Shipping-address').value;

  firebase.firestore().collection('stripe_customers').doc(uid).collection('details').add({ name: name, line1: line1, line2: line2, city: city, state: state, email: email, phone: phone, zipCode: zip}).then(() => {
    console.log('Details created in firestore.');
  });
}) 
  
  
$('#runCharge').click(function () {
  transferFormData();
  writeNewCharge();
});

$('#rstbtn').click(function () {
    document.getElementById('changetext').innerHTML = 'Enter your shipping information to complete checkout.'
    document.getElementById('shippingInfo').style.display = "block";
    document.getElementById('payment-form').style.display = "none";
    document.getElementById('rstbtn').style.display = "none";
});
